<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WPS MAROC | DASHBOARD EXPERT</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/shpjs@latest/dist/shp.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@200;300;400;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-void: #030712;
            --glass-panel: rgba(15, 23, 42, 0.96);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --neon-blue: #0ea5e9;
            --neon-purple: #8b5cf6;
            --neon-green: #10b981;
            --text-main: #f8fafc;
            --blur: blur(12px);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; user-select: none; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg-void); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; }

        /* --- CARTE --- */
        #map-container { flex-grow: 1; position: relative; z-index: 1; background: #000; }
        #map { width: 100%; height: 100%; }

        .leaflet-interactive { transition: all 0.2s; cursor: pointer; }
        .region-focus {
            stroke: white !important; stroke-width: 3px !important; stroke-opacity: 1 !important;
            fill-opacity: 0.6 !important; filter: drop-shadow(0 0 15px var(--neon-blue));
            z-index: 1000 !important;
        }
        .region-dimmed { fill-opacity: 0.1 !important; stroke: #1e293b !important; }

        /* --- MENU CONTEXTUEL (POPUP PETIT & PRÉCIS) --- */
        #ctx-menu {
            position: absolute; 
            z-index: 9999; /* Au-dessus de tout */
            display: none; 
            flex-direction: column; 
            gap: 5px;
            background: rgba(15, 23, 42, 0.95); 
            border: 1px solid var(--neon-blue);
            border-radius: 12px; 
            padding: 8px; 
            width: auto; /* Taille auto selon le contenu */
            min-width: 180px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            transform: translate(10px, 10px); /* Léger décalage par rapport à la souris */
        }

        .ctx-header {
            padding: 5px 10px; border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.75rem; font-weight: 700; color: var(--neon-blue);
            text-transform: uppercase; margin-bottom: 5px; white-space: nowrap;
        }

        .ctx-item {
            padding: 8px 12px; border-radius: 6px; cursor: pointer; color: white;
            display: flex; align-items: center; gap: 10px; font-size: 0.85rem;
            transition: 0.2s; white-space: nowrap;
        }
        .ctx-item:hover { background: var(--neon-blue); color: #020617; }

        /* --- SIDEBAR --- */
        #sidebar {
            width: 450px; background: var(--glass-panel); border-right: var(--glass-border);
            position: absolute; left: 0; top: 0; bottom: 0; z-index: 2000;
            transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column; box-shadow: 20px 0 50px rgba(0,0,0,0.8);
        }
        #sidebar.open { transform: translateX(0); }

        .header { padding: 25px; border-bottom: var(--glass-border); display: flex; justify-content: space-between; align-items: center; background: linear-gradient(90deg, rgba(14, 165, 233, 0.1), transparent); }
        .region-title { font-family: 'Orbitron', sans-serif; font-size: 1.2rem; letter-spacing: 1px; color: var(--neon-blue); text-transform: uppercase; }
        .close-btn { cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .close-btn:hover { color: #f43f5e; }

        .tabs { display: flex; padding: 15px 20px; gap: 10px; border-bottom: var(--glass-border); }
        .tab-btn { flex: 1; padding: 10px; background: rgba(255,255,255,0.03); border: var(--glass-border); color: #94a3b8; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.8rem; transition: 0.3s; }
        .tab-btn.active { background: var(--neon-blue); color: #020617; border-color: var(--neon-blue); }

        .content { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; gap: 20px; }
        .view-section { display: none; animation: slideIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes slideIn { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

        /* WIDGETS */
        .card { background: rgba(255,255,255,0.03); border: var(--glass-border); border-radius: 12px; padding: 15px; }
        .card-header { display: flex; align-items: center; gap: 8px; margin-bottom: 15px; font-size: 0.8rem; text-transform: uppercase; color: #94a3b8; font-weight: 700; }
        
        /* Stats Grids */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-box { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; text-align: center; }
        .stat-val { font-size: 1.2rem; font-weight: 700; color: white; }
        .stat-lbl { font-size: 0.7rem; color: #64748b; margin-top: 2px; }

        /* Animation Player */
        .ring-wrapper { display: flex; justify-content: center; margin: 15px 0; position: relative; }
        .ring-svg { transform: rotate(-90deg); width: 180px; height: 180px; }
        .ring-bg { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 8; }
        .ring-prog { fill: none; stroke: var(--neon-blue); stroke-width: 8; stroke-linecap: round; stroke-dasharray: 502; stroke-dashoffset: 502; transition: stroke-dashoffset 0.1s linear, stroke 0.2s; filter: drop-shadow(0 0 5px currentColor); }
        .ring-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .ring-temp { font-size: 2.5rem; font-weight: 800; line-height: 1; transition: color 0.2s; }
        .ring-date { font-size: 0.8rem; color: #94a3b8; margin-top: 5px; }

        .controls { display: flex; justify-content: center; gap: 15px; align-items: center; margin-top: 15px; }
        .btn-play { width: 50px; height: 50px; border-radius: 50%; background: white; border: none; color: #000; font-size: 1.2rem; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .btn-ctrl { background: rgba(255,255,255,0.1); border: none; color: white; width: 35px; height: 35px; border-radius: 50%; cursor: pointer; }

        /* Slider */
        .speed-control { background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 20px; display: flex; align-items: center; gap: 10px; margin-top: 15px; }
        input[type=range] { flex: 1; accent-color: var(--neon-blue); height: 4px; cursor: pointer; }

        /* Tooltip Carte */
        .map-tooltip { position: absolute; pointer-events: none; background: rgba(15, 23, 42, 0.9); border: 1px solid var(--neon-blue); padding: 8px 12px; border-radius: 6px; color: white; font-size: 0.8rem; z-index: 4000; opacity: 0; box-shadow: 0 5px 15px black; transform: translate(15px, 15px); }
        .map-tooltip.visible { opacity: 1; }

        /* Loader */
        #loader { position: fixed; inset: 0; background: #020617; z-index: 99999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--neon-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* =========================================
           ANIMATIONS DE SURVOL (HOVER EFFECTS)
           ========================================= */

        /* 1. Effet "Lévitation + Néon" pour les boîtes de stats (Climat, Agri) */
        .stat-box, .era5-box, .impact-cell {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            z-index: 1;
            cursor: default;
        }

        .stat-box:hover, .era5-box:hover, .impact-cell:hover {
            transform: translateY(-5px) scale(1.02); /* Soulève légèrement */
            background: rgba(255, 255, 255, 0.1);   /* Eclaircit le fond */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3), 
                        0 0 15px rgba(56, 189, 248, 0.2); /* Lueur bleue */
            border: 1px solid rgba(56, 189, 248, 0.3); /* Bordure lumineuse */
        }

        /* Petit effet sur le texte à l'intérieur */
        .stat-box:hover .stat-val, 
        .era5-box:hover .era5-val {
            text-shadow: 0 0 10px currentColor; /* Le texte brille */
        }

        /* 2. Effet "Glissement" pour la liste Démographie */
        .demo-item {
            transition: transform 0.2s ease, background 0.2s ease;
            padding: 5px 8px; /* Un peu d'espace pour l'effet */
            border-radius: 6px;
            margin: 0 -8px 12px -8px; /* Compensation du padding */
        }

        .demo-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(10px); /* Glisse vers la droite */
        }

        .demo-item:hover .demo-label {
            color: white; /* Le texte gris devient blanc */
        }

        /* 3. Effet "Focus" sur les Widgets principaux */
        .widget, .card {
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .widget:hover, .card:hover {
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }

        /* 4. Effet sur les boutons de contrôle (Play/Pause) */
        .btn-ctrl, .btn-play {
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), box-shadow 0.2s;
        }

        .btn-ctrl:active, .btn-play:active {
            transform: scale(0.9); /* Clic enfoncé */
        }
        /* =========================================
           LANDING PAGE (ÉCRAN D'ACCUEIL)
           ========================================= */
        #landing-screen {
            position: fixed; inset: 0; z-index: 9000;
            background: rgba(2, 6, 23, 0.85); /* Fond sombre transparent */
            backdrop-filter: blur(15px); /* Effet de flou sur la carte derrière */
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1), transform 0.8s;
        }
        
        #landing-screen.hidden {
            opacity: 0; pointer-events: none; transform: scale(1.1);
        }

        .landing-content {
            text-align: center; max-width: 800px; padding: 40px;
            background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(56, 189, 248, 0.2);
            border-radius: 24px; box-shadow: 0 0 100px rgba(0,0,0,0.5);
            position: relative; overflow: hidden;
        }

        /* Ligne lumineuse décorative */
        .landing-content::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: linear-gradient(90deg, transparent, var(--accent), transparent);
        }

        .landing-title {
            font-family: 'Orbitron', sans-serif; font-size: 3.5rem; font-weight: 800;
            margin-bottom: 10px; letter-spacing: 4px;
            background: linear-gradient(to bottom, #fff, #94a3b8);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .landing-subtitle {
            font-size: 1.2rem; color: var(--accent); margin-bottom: 30px;
            letter-spacing: 2px; text-transform: uppercase; font-weight: 600;
        }

        .landing-desc {
            font-size: 1rem; color: #cbd5e1; line-height: 1.6; margin-bottom: 40px;
            max-width: 600px; margin-left: auto; margin-right: auto;
        }

        .features-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 40px;
        }

        .feature-item {
            padding: 20px; background: rgba(255,255,255,0.03); border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.05); transition: 0.3s;
        }
        .feature-item:hover { transform: translateY(-5px); background: rgba(56, 189, 248, 0.1); border-color: var(--accent); }
        .feature-icon { font-size: 2rem; margin-bottom: 15px; color: var(--accent); }
        .feature-title { font-weight: 700; color: white; margin-bottom: 5px; }
        .feature-text { font-size: 0.8rem; color: #94a3b8; }

        .btn-start {
            padding: 18px 50px; font-size: 1.1rem; font-weight: 700;
            background: white; color: #020617; border: none; border-radius: 50px;
            cursor: pointer; letter-spacing: 2px; text-transform: uppercase;
            box-shadow: 0 0 30px rgba(255,255,255,0.2); transition: all 0.3s;
            position: relative; overflow: hidden;
        }
        
        .btn-start:hover {
            transform: scale(1.05); box-shadow: 0 0 50px var(--accent);
            background: var(--accent); color: white;
        }
    </style>
</head>
<body>
    <div id="landing-screen">
        <div class="landing-content">
            <h1 class="landing-title">WPS MAROC</h1>
            <div class="landing-subtitle">Système d'Intelligence Territoriale</div>
            
            <p class="landing-desc">
                Une plateforme d'analyse géospatiale de nouvelle génération combinant données satellitaires ERA5, 
                statistiques démographiques et modèles agricoles pour le Royaume du Maroc.
            </p>

            <div class="features-grid">
                <div class="feature-item">
                    <i class="fas fa-satellite feature-icon"></i>
                    <div class="feature-title">Données ERA5</div>
                    <div class="feature-text">Analyse climatique temps réel et historique thermique.</div>
                </div>
                <div class="feature-item">
                <i class="fas fa-wheat-awn feature-icon" style="color:var(--neon-green)"></i>
                    <div class="feature-title">Agriculture</div>
                    <div class="feature-text">Surveillance des cultures et évaluation des risques.</div>
                </div>
                <div class="feature-item">
                    <i class="fas fa-chart-pie feature-icon" style="color:var(--neon-purple)"></i>
                    <div class="feature-title">Démographie</div>
                    <div class="feature-text">Indicateurs socio-économiques par région.</div>
                </div>
            </div>

            <button class="btn-start" onclick="enterDashboard()">
                Explorer la carte <i class="fas fa-arrow-right" style="margin-left:10px;"></i>
            </button>
        </div>
        
        <div style="margin-top:20px; font-size:0.8rem; color:#64748b;">
            Version 2025.1.0 • Propulsé par PyWPS & Leaflet
        </div>
    </div>

    <div id="loader"><div class="spinner"></div></div>

    <div id="map-tooltip" class="map-tooltip">
        <div style="font-weight:700; color:var(--neon-blue)">METEO LIVE</div>
        <div id="tt-content">--</div>
    </div>

    <div id="ctx-menu">
        <div class="ctx-header" id="ctx-title">RÉGION</div>
        <div class="ctx-item" onclick="launchAnalysis('climat')">
            <i class="fas fa-play-circle" style="color:var(--neon-blue)"></i> Climat & Animation
        </div>
        <div class="ctx-item" onclick="launchAnalysis('agri')">
            <i class="fas fa-seedling" style="color:var(--neon-green)"></i> Agriculture
        </div>
        <div class="ctx-item" onclick="launchAnalysis('stats')">
            <i class="fas fa-chart-bar" style="color:var(--neon-purple)"></i> Démographie
        </div>
    </div>

    <div id="sidebar">
        <div class="header">
            <div class="region-title" id="sb-title">RÉGION</div>
            <div class="close-btn" onclick="closeSidebar()"><i class="fas fa-times"></i></div>
        </div>

        <div class="tabs">
            <button class="tab-btn active" id="btn-climat" onclick="switchTab('climat')">CLIMAT</button>
            <button class="tab-btn" id="btn-agri" onclick="switchTab('agri')">AGRI</button>
            <button class="tab-btn" id="btn-stats" onclick="switchTab('stats')">STATS</button>
        </div>

        <div class="content">
            
            <div id="view-climat" class="view-section active">
                <div class="card" style="border-left:3px solid var(--neon-blue)">
                    <div class="card-header"><i class="fas fa-clock"></i> Animation Temporelle</div>
                    
                    <div class="ring-wrapper">
                        <div class="ring-container">
                            <svg class="ring-svg" viewBox="0 0 200 200">
                                <circle class="ring-bg" cx="100" cy="100" r="90"></circle>
                                <circle class="ring-prog" id="ring-prog" cx="100" cy="100" r="90"></circle>
                            </svg>
                            <div class="ring-center">
                                <div class="ring-temp" id="player-temp">--°</div>
                                <div class="ring-date" id="player-date">Date</div>
                            </div>
                        </div>
                    </div>

                    <div class="controls">
                        <button class="btn-ctrl" onclick="stepFrame(-5)"><i class="fas fa-backward"></i></button>
                        <button class="btn-play" id="btn-play" onclick="togglePlay()"><i class="fas fa-play"></i></button>
                        <button class="btn-ctrl" onclick="stepFrame(5)"><i class="fas fa-forward"></i></button>
                    </div>

                    <div style="display:flex; gap:10px; margin-top:15px;">
                        <input type="date" id="d-start" value="2024-01-01" style="flex:1; background:rgba(255,255,255,0.1); border:none; color:white; padding:8px; border-radius:6px;">
                        <input type="date" id="d-end" value="2024-12-31" style="flex:1; background:rgba(255,255,255,0.1); border:none; color:white; padding:8px; border-radius:6px;">
                    </div>
                    <button onclick="reloadEvolution()" style="width:100%; margin-top:10px; padding:10px; background:var(--neon-blue); border:none; border-radius:6px; font-weight:700; cursor:pointer;">APPLIQUER</button>
                    
                    <div class="speed-control">
                        <span style="font-size:0.7rem; color:#94a3b8">LENT</span>
                        <input type="range" id="speed-slider" min="10" max="300" value="150" oninput="updateSpeed(this.value)">
                        <span style="font-size:0.7rem; color:#94a3b8">RAPIDE</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><i class="fas fa-chart-line"></i> Bilan Climatique</div>
                    <div class="stat-grid" style="grid-template-columns:1fr 1fr 1fr">
                        <div class="stat-box"><div class="stat-val" style="color:#38bdf8" id="c-min">--</div><div class="stat-lbl">MIN</div></div>
                        <div class="stat-box"><div class="stat-val" style="color:#fbbf24" id="c-moy">--</div><div class="stat-lbl">MOY</div></div>
                        <div class="stat-box"><div class="stat-val" style="color:#f43f5e" id="c-max">--</div><div class="stat-lbl">MAX</div></div>
                    </div>
                </div>
            </div>

            <div id="view-agri" class="view-section">
                <div class="card" style="border-left:3px solid var(--neon-green)">
                    <div class="card-header"><i class="fas fa-seedling"></i> Agriculture</div>
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="stat-val" id="ag-surf">--</div>
                            <div class="stat-lbl">km²</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-val" style="color:var(--neon-green)" id="ag-pct">--%</div>
                            <div class="stat-lbl">Occupation</div>
                        </div>
                    </div>
                    <div style="margin-top:15px; padding:10px; background:rgba(255,255,255,0.05); border-radius:8px; font-size:0.85rem;">
                        <span style="color:#94a3b8">CULTURES :</span> <span id="ag-crops">...</span>
                    </div>
                </div>
                <div class="card" style="border-left:3px solid #fbbf24">
                    <div class="card-header"><i class="fas fa-exclamation-triangle"></i> Risques</div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                        <span style="color:#94a3b8">Niveau</span>
                        <strong id="ag-risk" style="color:white">--</strong>
                    </div>
                    <div id="ag-reco" style="font-size:0.85rem; color:#cbd5e1; line-height:1.4">...</div>
                </div>
            </div>

            <div id="view-stats" class="view-section">
                <div class="card" style="border-left:3px solid var(--neon-purple)">
                    <div class="card-header"><i class="fas fa-users"></i> Démographie</div>
                    <div style="margin-bottom:15px; display:flex; justify-content:space-between; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px;">
                        <span style="color:#94a3b8">Nom Arabe</span>
                        <span id="val-arabe" style="font-family:'Amiri',serif; font-size:1.4rem; color:var(--neon-purple)">...</span>
                    </div>
                    <div id="demo-container">
                        <p style="text-align:center; opacity:0.5; font-size:0.8rem">Chargement...</p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <div id="map-container"><div id="map"></div></div>

<script>
function enterDashboard() {
        // Ajoute la classe qui fait disparaître l'écran avec une transition CSS
        const screen = document.getElementById('landing-screen');
        screen.classList.add('hidden');
        
        // Supprime l'élément du DOM après l'animation pour libérer la mémoire
        setTimeout(() => {
            screen.style.display = 'none';
        }, 800);
    }
const DOMAIN = "https://wps-maroc.onrender.com";
const CONFIG = {
    WPS: DOMAIN + "/wps",
    ZIP: DOMAIN + "/data/regions.zip"
};
    let app = { map:null, geojson:null, selectedLayer:null, regionName:null, evoData:[], anim:{playing:false, idx:0, timer:null, speed:100} };

    window.onload = () => { initMap(); loadData(); };

    function initMap() {
        app.map = L.map('map', {zoomControl:false, attributionControl:false}).setView([29.0, -5.0], 5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {maxZoom:19}).addTo(app.map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_only_labels/{z}/{x}/{y}{r}.png').addTo(app.map);
        
        // Clic sur fond de carte = Fermer menu
        app.map.on('click', () => {
            document.getElementById('ctx-menu').style.display='none';
            if(!document.getElementById('sidebar').classList.contains('open')) resetMap();
        });

        // Tooltip Souris
        const tt = document.getElementById('map-tooltip');
        app.map.on('mousemove', (e) => {
            if(app.anim.playing && app.selectedLayer) {
                tt.style.left = (e.originalEvent.pageX + 15) + 'px';
                tt.style.top = (e.originalEvent.pageY + 15) + 'px';
                tt.classList.add('visible');
            } else {
                tt.classList.remove('visible');
            }
        });
    }

    async function loadData() {
        try {
            const geojson = await shp(CONFIG.ZIP);
            app.geojson = L.geoJSON(geojson, {
                style: { fillColor:'#0ea5e9', weight:1, color:'#0284c7', fillOpacity:0.1 },
                onEachFeature: setupInteractions
            }).addTo(app.map);
            app.map.fitBounds(app.geojson.getBounds());
            document.getElementById('loader').style.display='none';
        } catch(e) { alert("Erreur ZIP: "+e.message); document.getElementById('loader').style.display='none'; }
    }

    function setupInteractions(feature, layer) {
        layer.on('click', (e) => {
            L.DomEvent.stopPropagation(e);
            
            // RESET COMPLET (Pour éviter superposition)
            if(app.selectedLayer && app.selectedLayer !== layer) resetMap(false);

            const p = feature.properties;
            app.regionName = p.nom_region || p.NAME_1 || p.ADM1_FR;
            app.selectedLayer = layer;

            // Affichage Menu Popup
            const menu = document.getElementById('ctx-menu');
            const pt = e.originalEvent;
            
            // Calcul position intelligente
            let left = pt.pageX + 10;
            let top = pt.pageY + 10;
            if(left + 240 > window.innerWidth) left -= 260;
            if(top + 150 > window.innerHeight) top -= 160;

            menu.style.left = left + 'px';
            menu.style.top = top + 'px';
            menu.style.display = 'flex';
            document.getElementById('ctx-title').innerText = app.regionName;
        });

        // Effet Hover
        layer.on('mouseover', () => { if(layer !== app.selectedLayer) layer.setStyle({fillOpacity:0.3, weight:2}); });
        layer.on('mouseout', () => { if(layer !== app.selectedLayer) app.geojson.resetStyle(layer); });
    }

    function launchAnalysis(tab) {
        document.getElementById('ctx-menu').style.display='none';
        
        // Focus Visuel
        app.geojson.eachLayer(l => l.setStyle({fillOpacity:0.05, color:'#1e293b'}));
        app.selectedLayer.setStyle({fillOpacity:0.6, color:'white', weight:3});
        app.selectedLayer.bringToFront();
        app.selectedLayer.getElement().classList.add('region-focus');
        app.map.fitBounds(app.selectedLayer.getBounds(), {padding:[300,300], duration:1.5});

        document.getElementById('sidebar').classList.add('open');
        document.getElementById('sb-title').innerText = app.regionName;
        switchTab(tab);
    }

    function switchTab(tab) {
        ['climat','agri','stats'].forEach(t => {
            document.getElementById(`btn-${t}`).className = t===tab ? 'tab-btn active' : 'tab-btn';
            document.getElementById(`view-${t}`).style.display = t===tab ? 'block' : 'none';
        });

        if(tab==='climat') loadClimat();
        if(tab==='agri') loadAgri();
        if(tab==='stats') { stopAnim(); loadStats(); }
    }

    // --- LOGIQUE METIER ---
    async function loadClimat() {
        stopAnim();
        reloadEvolution();
    }

    async function reloadEvolution() {
        stopAnim();
        const start = document.getElementById('d-start').value;
        const end = document.getElementById('d-end').value;
        
        const evo = await executeWPS('evolution_temperature', {
            region: app.regionName, date_debut: start, date_fin: end
        });

        if(evo.evolution && evo.evolution.length > 0) {
            app.evoData = evo.evolution;
            
            // Stats
            document.getElementById('c-moy').innerText = evo.statistiques.moyenne + "°";
            document.getElementById('c-min').innerText = evo.statistiques.min + "°";
            document.getElementById('c-max').innerText = evo.statistiques.max + "°";

            app.anim.idx = 0;
            renderFrame(0);
            togglePlay();
        }
    }

    function togglePlay() {
        app.anim.playing = !app.anim.playing;
        document.getElementById('btn-play').innerHTML = app.anim.playing ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
        if(app.anim.playing) loop();
    }

    function stopAnim() {
        app.anim.playing = false;
        clearTimeout(app.anim.timer);
        document.getElementById('btn-play').innerHTML = '<i class="fas fa-play"></i>';
        document.getElementById('map-tooltip').classList.remove('visible');
    }

    function loop() {
        if(!app.anim.playing) return;
        app.anim.idx += 0.5; // Fluidité
        if(app.anim.idx >= app.evoData.length-1) app.anim.idx = 0;
        renderFrame(app.anim.idx);
        app.anim.timer = setTimeout(loop, app.anim.speed);
    }

    function renderFrame(idx) {
        if(!app.evoData.length) return;
        const i1 = Math.floor(idx), i2 = Math.min(i1+1, app.evoData.length-1);
        const r = idx - i1;
        const d1 = app.evoData[i1], d2 = app.evoData[i2];
        const temp = d1.temperature_c + (d2.temperature_c - d1.temperature_c)*r;

        // UI
        const pct = (idx/(app.evoData.length-1)) * 502; // SVG dash
        document.getElementById('ring-prog').style.strokeDashoffset = 502 - pct;
        document.getElementById('player-temp').innerText = Math.round(temp)+"°";
        document.getElementById('player-date').innerText = d1.date;
        
        const color = getHeatColor(temp);
        document.getElementById('ring-prog').style.stroke = color;
        document.getElementById('player-temp').style.color = color;

        if(app.selectedLayer) app.selectedLayer.setStyle({fillColor:color, fillOpacity:0.8});
        document.getElementById('tt-content').innerHTML = `<span style="font-size:1.5rem; color:${color}">${temp.toFixed(1)}°C</span>`;
    }

    function getHeatColor(t) {
        if(t<10) return '#38bdf8'; if(t<20) return '#10b981'; if(t<30) return '#fbbf24'; return '#f43f5e';
    }

    function stepFrame(d) {
        stopAnim();
        app.anim.idx+=d; if(app.anim.idx<0)app.anim.idx=0; if(app.anim.idx>=app.evoData.length)app.anim.idx=app.evoData.length-1;
        renderFrame(app.anim.idx);
    }

    function updateSpeed(v) { app.anim.speed = 310 - v; }

    async function loadAgri() {
        stopAnim();
        const res = await executeWPS('impact_climatique', {region: app.regionName});
        if(!res.error) {
            const ag = res.donnees_agricoles;
            document.getElementById('ag-surf').innerText = ag.superficie_agricole_km2.toLocaleString();
            document.getElementById('ag-pct').innerText = ag.pourcentage_agricole + "%";
            document.getElementById('ag-crops').innerText = ag.cultures_principales.join(', ');
            
            const risk = res.analyse_impact.risque_thermique;
            const badge = document.getElementById('ag-risk');
            badge.innerText = risk.niveau;
            badge.style.color = risk.couleur==='rouge'?'#f43f5e': risk.couleur==='orange'?'#fbbf24':'#10b981';
            document.getElementById('ag-reco').innerText = res.analyse_impact.recommandations[0];
        }
    }

    async function loadStats() {
        const div = document.getElementById('demo-container');
        div.innerHTML = "Chargement...";
        const res = await executeWPS('stats_regions', {region: app.regionName});
        div.innerHTML = "";
        
        if(res.donnees) {
            document.getElementById('val-arabe').innerText = res.nom_arabe || "";
            const d = res.donnees;
            const keys = Object.keys(d).filter(k => typeof d[k]==='number' && !['id','code'].some(s=>k.toLowerCase().includes(s)));
            const max = Math.max(...keys.map(k=>d[k]));

            keys.forEach(k => {
                const pct = (d[k]/max)*100;
                div.innerHTML += `<div style="margin-bottom:10px;"><div style="display:flex;justify-content:space-between;font-size:0.8rem;color:#94a3b8;margin-bottom:4px;"><span style="text-transform:capitalize;">${k.replace(/_/g,' ')}</span><span style="font-weight:700;color:white">${d[k].toLocaleString()}</span></div><div style="height:4px;background:rgba(255,255,255,0.1);border-radius:2px;"><div style="height:100%;width:${pct}%;background:#8b5cf6;border-radius:2px;"></div></div></div>`;
            });
        }
    }

    function resetMap(closeSide=true) {
        stopAnim();
        if(closeSide) document.getElementById('sidebar').classList.remove('open');
        if(app.selectedLayer) {
            app.selectedLayer.getElement()?.classList.remove('region-focus');
            app.geojson.resetStyle(app.selectedLayer);
        }
        app.selectedLayer = null;
        if(closeSide) app.map.setView([29.0, -5.0], 5);
        document.getElementById('map-tooltip').classList.remove('visible');
    }

    function closeSidebar() { resetMap(true); }

    async function executeWPS(proc, inputs) {
        let block = '';
        for(let [k,v] of Object.entries(inputs)) block += `<wps:Input><ows:Identifier>${k}</ows:Identifier><wps:Data><wps:LiteralData>${v}</wps:LiteralData></wps:Data></wps:Input>`;
        const xml = `<?xml version="1.0" encoding="UTF-8"?><wps:Execute version="1.0.0" service="WPS" xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.opengis.net/wps/1.0.0 ../wpsExecute_request.xsd"><ows:Identifier>${proc}</ows:Identifier><wps:DataInputs>${block}</wps:DataInputs><wps:ResponseForm><wps:RawDataOutput mimeType="application/json"><ows:Identifier>output</ows:Identifier></wps:RawDataOutput></wps:ResponseForm></wps:Execute>`;
        const r = await fetch(CONFIG.WPS, {method:'POST', headers:{'Content-Type':'text/xml'}, body:xml});
        return await r.json();
    }
</script>
</body>
</html>